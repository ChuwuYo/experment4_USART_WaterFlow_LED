# STM32F103VE Modbus RTU LED控制实验项目

## 项目简介

这是一个基于STM32F103VE微控制器的Modbus RTU从机实验项目，实现了完整的Modbus RTU通信协议，并通过Modbus命令控制8个LED灯的亮灭和移位显示效果。该项目展示了嵌入式系统中的工业通信协议应用，是学习Modbus协议和STM32开发的优秀范例。

## 硬件平台

- **微控制器**：STM32F103VET6
- **主频**：72MHz（外部晶振9倍频）
- **LED灯**：8个LED灯连接到GPIOE端口（LED0-LED7）
- **通信接口**：USART1（Modbus RTU通信）
- **开发板**：支持STM32F103VE系列开发板

## 功能特性

### Modbus RTU协议支持

- **设备地址**：0x01（可配置）
- **支持功能码**：
  - `0x01` - 读取线圈状态
  - `0x03` - 读取保持寄存器
  - `0x05` - 写入单个线圈
  - `0x06` - 写入单个寄存器
  - `0x0F` - 写入多个线圈

### LED控制功能

- **单独控制**：可独立控制8个LED灯的亮灭
- **移位效果**：
  - 右移模式：LED灯依次向右移动
  - 左移模式：LED灯依次向左移动
  - 停止模式：保持当前状态
- **状态查询**：可查询任意LED灯的状态

### 寄存器映射

| 地址 | 寄存器类型 | 功能 | 说明 |
|------|-----------|------|------|
| 0x0000 | 保持寄存器 | LED模式控制 | 0=停止, 1=右移, 2=左移 |
| 0x0001 | 保持寄存器 | LED值控制 | 8位LED显示值 |
| 0x0001-0x0008 | 线圈 | LED1-LED8控制 | 单独控制每个LED |

## 项目结构

```
experment4_USART_WaterFlow_LED/
├── Src/                          # 源代码目录
│   ├── main.c                    # 主程序（含Modbus协议实现）
│   ├── gpio.c                    # GPIO配置
│   ├── usart.c                   # USART配置
│   ├── stm32f1xx_hal_msp.c       # HAL外设初始化
│   ├── stm32f1xx_it.c           # 中断处理
│   └── system_stm32f1xx.c        # 系统配置
├── Inc/                          # 头文件目录
│   ├── main.h                    # 主程序头文件
│   ├── gpio.h                    # GPIO头文件
│   ├── usart.h                   # USART头文件
│   ├── stm32f1xx_hal_conf.h      # HAL配置
│   └── stm32f1xx_it.h           # 中断处理头文件
├── Drivers/                      # STM32 HAL驱动库
├── MDK-ARM/                      # Keil MDK项目文件
├── EWARM/                        # IAR项目文件
└── README.md                     # 项目说明文档
```

## 软件架构

### Modbus协议实现

- **CRC16校验**：完整的Modbus RTU CRC16算法实现
- **帧处理**：自动解析Modbus数据帧，验证CRC和地址
- **异常处理**：支持Modbus标准异常响应
- **状态机**：串口接收状态机，确保帧完整性

### LED控制实现

- **查找表优化**：使用GPIO端口和引脚查找表，提高访问效率
- **移位算法**：实现循环左移和右移算法
- **状态同步**：LED硬件状态与寄存器状态实时同步

## 编译环境

### Keil MDK-ARM
- 芯片型号：STM32F103VE
- 优化等级：O2
- 输出格式：HEX文件

### IAR EWARM
- 芯片型号：STM32F103VE
- 优化等级：High

## 使用方法

### 硬件连接

1. 将STM32开发板与Modbus主设备连接
2. 连接USART1的TX和RX引脚
3. 确保LED灯正确连接到GPIOE端口

### Modbus命令示例

#### 1. 启动右移模式
```
设备地址: 01
功能码: 06
寄存器地址高字节: 00
寄存器地址低字节: 00
数据高字节: 00
数据低字节: 01
CRC校验码: 48 0A
```

#### 2. 单独点亮LED1
```
设备地址: 01
功能码: 05
线圈地址高字节: 00
线圈地址低字节: 01
状态高字节: FF
状态低字节: 00
CRC校验码: 9C 3A
```

#### 3. 查询所有LED状态
```
设备地址: 01
功能码: 01
起始地址高字节: 00
起始地址低字节: 01
线圈数量高字节: 00
线圈数量低字节: 08
CRC校验码: BD CC
```

## 开发说明

### 代码特点

- **模块化设计**：Modbus协议与LED控制逻辑分离
- **注释详细**：每个函数都有详细的中文注释说明
- **错误处理**：完善的CRC校验和异常处理机制
- **性能优化**：使用查找表提高GPIO访问效率

### 调试建议

1. 使用Modbus调试工具测试通信
2. 检查串口波特率设置（默认9600bps）
3. 验证CRC校验码计算是否正确
4. 使用LED灯状态指示程序运行状态
